{% extends "_base.html" %}

{% block title %}Add Job Card - KFactor{% endblock %}

{% block content %}
<main class="relative h-full max-h-screen transition-all duration-200 ease-in-out xl:ml-68 rounded-xl">
    <div class="w-full px-6 py-6 mx-auto">
    <div class="flex flex-wrap -mx-3">
      <div class="w-full max-w-full px-3 mt-6 lg:w-2/3 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white border-0 border-solid border-transparent rounded-2xl bg-clip-border shadow-soft-xl">
          <div class="p-4 pb-0 mb-0 bg-white border-b-0 rounded-t-2xl">
            <div class="flex flex-wrap -mx-3">
              <div class="w-full max-w-full px-3 flex-0">
                <h6 class="mb-0 font-bold dark:text-white">Add New Job Card</h6>
                <p class="mb-0 text-sm leading-normal dark:text-white dark:opacity-60">
                  Create a new job card with detailed information
                </p>
              </div>
            </div>
          </div>
          <div class="flex-auto p-4">
            <form method="POST" class="space-y-6">
              <!-- Basic Information -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Job Number *</label>
                  <input type="text" name="job_number" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Driver *</label>
                  <select name="driver_id" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Driver</option>
                    {% for employee in employees %}
                      <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }} ({{ employee.employee_id }})</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Car *</label>
                  <select name="car_id" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Car</option>
                    {% for car in cars %}
                      <option value="{{ car.id }}">{{ car.model }} ({{ car.registration_number }})</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Trailer</label>
                  <select name="trailer_id" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Trailer (Optional)</option>
                    {% for trailer in trailers %}
                      <option value="{{ trailer.id }}">{{ trailer.model }} ({{ trailer.registration_number }})</option>
                    {% endfor %}
                  </select>
                </div>
                

                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Priority</label>
                  <select name="priority" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
              </div>

              <!-- Timing Information -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Pickup Time</label>
                  <input type="datetime-local" name="pickup_time" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Estimated Arrival Time</label>
                  <input type="datetime-local" name="estimated_arrival_time" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
              </div>

              <!-- Financial Information -->
             

              <!-- Companies Section -->
              <div class="border-t pt-6">
                <h6 class="text-lg font-semibold text-slate-700 dark:text-white mb-4">Companies & Delivery Orders</h6>
                
                <div id="companies-container">
                  <div class="company-entry grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                      <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Company</label>
                      <select name="company_ids" class="company-select w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Company</option>
                        {% for company in companies %}
                          <option value="{{ company.id }}">{{ company.name }}</option>
                        {% endfor %}
                        <option value="new">+ Add New Company</option>
                      </select>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Delivery Order</label>
                      <input type="number" name="delivery_orders" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Order number">
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Fuel Type</label>
                      <select name="fuel_types" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Fuel Type</option>
                        {% for fuel in fuels %}
                          <option value="{{ fuel.name }}">{{ fuel.name }} ({{ fuel.price_per_litre }})</option>
                        {% endfor %}
                      </select>
                    </div>
                    
                    <div class="flex items-end">
                      <button type="button" class="remove-company bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash"></i> Remove
                      </button>
                    </div>
                  </div>
                </div>
                
                <button type="button" id="add-company" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                  <i class="fas fa-plus"></i> Add Another Company
                </button>
              </div>

              <!-- Additional Information -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Special Instructions</label>
                  <textarea name="special_instructions" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Any special instructions for this job"></textarea>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Notes</label>
                  <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Additional notes"></textarea>
                </div>
              </div>

              <!-- Status -->
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Status</label>
                <select name="status" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="assigned" selected>Assigned</option>
                  <option value="in_progress">In Progress</option>
                  <option value="picked_up">Picked Up</option>
                  <option value="in_transit">In Transit</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>

              <!-- Submit Buttons -->
              <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{{ url_for('superadmin_routes.manage_job_cards') }}" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                  Cancel
                </a>
                <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                  Create Job Card
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Company Statistics Card -->
      <div class="w-full max-w-full px-3 mt-6 lg:w-1/3 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white border-0 border-solid border-transparent rounded-2xl bg-clip-border shadow-soft-xl">
          <div class="p-4 pb-0 mb-0 bg-white border-b-0 rounded-t-2xl">
            <div class="flex flex-wrap -mx-3">
              <div class="w-full max-w-full px-3 flex-0">
                <h6 class="mb-0 font-bold dark:text-white">Company Statistics</h6>
                <p class="mb-0 text-sm leading-normal dark:text-white dark:opacity-60">
                  Overview of companies
                </p>
              </div>
            </div>
          </div>
          <div class="flex-auto p-4">
            <div class="space-y-6">
              <!-- Total Companies -->
              <div class="flex items-center justify-between p-4 bg-gradient-to-tl from-blue-500 to-violet-500 rounded-lg text-white">
                <div>
                  <p class="text-sm opacity-80">Total Companies</p>
                  <h4 class="text-2xl font-bold">{{ companies|length if companies else 0 }}</h4>
                </div>
                <div class="text-3xl opacity-80">
                  <i class="fas fa-building"></i>
                </div>
              </div>

              <!-- Active Companies -->
              <div class="flex items-center justify-between p-4 bg-gradient-to-tl from-emerald-500 to-teal-400 rounded-lg text-white">
                <div>
                  <p class="text-sm opacity-80">Active Companies</p>
                  <h4 class="text-2xl font-bold">
                    {% if companies %}
                      {{ companies|selectattr('is_active', 'equalto', true)|list|length }}
                    {% else %}
                      0
                    {% endif %}
                  </h4>
                </div>
                <div class="text-3xl opacity-80">
                  <i class="fas fa-check"></i>
                </div>
              </div>

              <!-- Inactive Companies -->
              <div class="flex items-center justify-between p-4 bg-gradient-to-tl from-red-500 to-orange-400 rounded-lg text-white">
                <div>
                  <p class="text-sm opacity-80">Inactive Companies</p>
                  <h4 class="text-2xl font-bold">
                    {% if companies %}
                      {{ companies|rejectattr('is_active')|list|length }}
                    {% else %}
                      0
                    {% endif %}
                  </h4>
                </div>
                <div class="text-3xl opacity-80">
                  <i class="fas fa-times"></i>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="space-y-3">
                <h6 class="text-sm font-semibold text-slate-700 dark:text-white">Quick Actions</h6>
                
                <button type="button" id="show-add-company-form" class="w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                  <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                      <i class="fas fa-plus text-blue-600 text-sm"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-700 dark:text-white">Add Company</span>
                  </div>
                  <i class="fas fa-chevron-right text-slate-400 text-xs"></i>
                </button>

                <div id="add-company-form" class="hidden space-y-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                  <h6 class="text-sm font-semibold text-slate-700 dark:text-white">Add New Company</h6>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Company Name *</label>
                    <input type="text" id="company-name" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Address</label>
                    <textarea id="company-address" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Contact Person</label>
                    <input type="text" id="company-contact" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Phone</label>
                    <input type="text" id="company-phone" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Email</label>
                    <input type="email" id="company-email" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  </div>
                  
                  <div class="flex space-x-2">
                    <button type="button" id="save-company" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                      Save Company
                    </button>
                    <button type="button" id="cancel-add-company" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const companiesContainer = document.getElementById('companies-container');
    const addCompanyBtn = document.getElementById('add-company');
    const showAddCompanyFormBtn = document.getElementById('show-add-company-form');
    const addCompanyForm = document.getElementById('add-company-form');
    const saveCompanyBtn = document.getElementById('save-company');
    const cancelAddCompanyBtn = document.getElementById('cancel-add-company');
    let currentSelect = null;

    // Show/hide add company form in statistics card
    showAddCompanyFormBtn.addEventListener('click', function() {
        addCompanyForm.classList.toggle('hidden');
    });

    // Cancel add company form
    cancelAddCompanyBtn.addEventListener('click', function() {
        addCompanyForm.classList.add('hidden');
        // Reset form
        document.getElementById('company-name').value = '';
        document.getElementById('company-address').value = '';
        document.getElementById('company-contact').value = '';
        document.getElementById('company-phone').value = '';
        document.getElementById('company-email').value = '';
    });

    // Save company from statistics card
    saveCompanyBtn.addEventListener('click', function() {
        const name = document.getElementById('company-name').value;
        const address = document.getElementById('company-address').value;
        const contact_person = document.getElementById('company-contact').value;
        const phone = document.getElementById('company-phone').value;
        const email = document.getElementById('company-email').value;
        
        if (!name) {
            alert('Company name is required');
            return;
        }
        
        const formData = new FormData();
        formData.append('name', name);
        formData.append('address', address);
        formData.append('contact_person', contact_person);
        formData.append('phone', phone);
        formData.append('email', email);
        
        fetch('/super_admin/add-company-ajax', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new company to all select dropdowns
                const newOption = new Option(data.company.name, data.company.id);
                document.querySelectorAll('.company-select').forEach(select => {
                    select.add(newOption.cloneNode(true));
                });
                
                // Hide form and reset
                addCompanyForm.classList.add('hidden');
                document.getElementById('company-name').value = '';
                document.getElementById('company-address').value = '';
                document.getElementById('company-contact').value = '';
                document.getElementById('company-phone').value = '';
                document.getElementById('company-email').value = '';
                
                // Show success message
                alert('Company added successfully!');
                
                // Refresh page to update statistics
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding company');
        });
    });

    // Add company entry
    addCompanyBtn.addEventListener('click', function() {
        const companyEntry = document.createElement('div');
        companyEntry.className = 'company-entry grid grid-cols-1 md:grid-cols-4 gap-4 mb-4';
        companyEntry.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Company</label>
                <select name="company_ids" class="company-select w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Company</option>
                    ${Array.from(document.querySelector('.company-select').options).map(option => 
                        option.outerHTML
                    ).join('')}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Delivery Order</label>
                <input type="number" name="delivery_orders" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Order number">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Fuel Type</label>
                <select name="fuel_types" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Fuel Type</option>
                    ${Array.from(document.querySelector('select[name="fuel_types"]').options).map(option => 
                        option.outerHTML
                    ).join('')}
                </select>
            </div>
            
            <div class="flex items-end">
                <button type="button" class="remove-company bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        `;
        companiesContainer.appendChild(companyEntry);
        attachEventListeners(companyEntry);
    });

    // Remove company entry
    function attachEventListeners(container) {
        const removeBtn = container.querySelector('.remove-company');
        const select = container.querySelector('.company-select');
        
        removeBtn.addEventListener('click', function() {
            container.remove();
        });
        
        select.addEventListener('change', function() {
            if (this.value === 'new') {
                currentSelect = this;
                addCompanyForm.classList.remove('hidden');
            }
        });
    }

    // Attach initial event listeners
    document.querySelectorAll('.company-entry').forEach(attachEventListeners);
});
</script>
{% endblock %} 